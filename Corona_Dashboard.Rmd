---
title: "Corona Dashboard - `r format(Sys.time(), '%d. %B %Y - %H:%M')`" 
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(flexdashboard)
library(readr)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(magrittr)
library(lubridate)
library(tidyr)
library(zoo)
library(plotly)
library(wesanderson)
library(tidymetrics)
library(kableExtra)
library(ggthemes)
library(gghighlight)
library(here)
library(janitor)
library(glue)
library(readxl)
theme_set(theme_light())
```

```{r eval=FALSE, include=FALSE}
source(here("src/Fallzahlen_laden.R"))
source(here("src/Impfen_Neu.R"))

```

```{r Formeln}
NummernMitPunkt <- function(x, digits=0) {
  return(formatC(x, format="f", big.mark = ".", decimal.mark   = ",",digits))
}

# Moving Average
ma <- function(x, n = 7) {
  stats::filter(x, rep(1 / n, n), sides = 2)
}

#mooving sum
ms <- function(x, n = 7) {
    zoo::rollapply(x,n,sum,na.pad = T,align = "right")
  }

AusPunktKommaMachen <- function(x){
  z <- gsub("[^0-9,.]", "", x)
  z <- gsub("\\.", "", z)
  gsub(",", ".", z)
}


VergleichVortagePfeil <- function(data, Reihe, Anzahl = 5, reverse = TRUE) {
  Data <- data %>%
    select({{ Reihe }}) %>%
    mutate(t = {{ Reihe }}) %>%
    mutate(t_minus_1 = lag(t)) %>%
    drop_na() %>%
    mutate(vergleich = ifelse(t > t_minus_1, "+", ifelse(t == t_minus_1, "=", "-"))) %>%
    select(-t, -t_minus_1) %>%
    tail(Anzahl)

  # Die Funktion rev() ist hier ganz wichtig. damit die Pfeile in der richtigen Reihenfolge angezeigt werden.

  if (reverse == TRUE) {
    a <- stringr::str_c(rev(Data$vergleich), collapse = " ")
  }

  if (reverse == FALSE) {
    a <- stringr::str_c(Data$vergleich, collapse = " ")
  }

  return(a)
}



```

```{r DatenLaden, include=FALSE}

# wenn schon in der der Environment geladen, nicht erneut laden.
if (!exists("RKI_COVID19")) {
  RKI_COVID19 <-
    read_csv(paste0(here("data/RKI/working/RKI_COVID19_"), Sys.Date(), ".csv")) %>%
    mutate(
      Meldedatum = ymd(as.Date(Meldedatum)),
      Refdatum = ymd(as.Date(Refdatum)),
      Datenstand = as_date(dmy_hm(Datenstand))) %>%
    arrange(desc(Meldedatum))
}

if (!exists("Neufindektion_Datum_df")) {
Neufindektion_Datum_df <- read_csv(here("data/Erstellt/Neufindektion_Datum_df.csv"))
}

# if (!exists("RKI_Impf")) {
# RKI_Impf <- read_csv(here("data/RKI_Impf/final/RKI_Impf_gesamt.csv"))
# }
# 
# if (!exists("RKI_Impf_gesamt_täglich_neu")) {
# RKI_Impf_gesamt_täglich_neu <- read_csv(here("data/RKI_Impf/final/RKI_Impf_gesamt_aus_neusten_daten.csv"))
# }

if (!exists("RKI_Impf_heute_blatt_2")) {
RKI_Impf_heute_blatt_2 <- read_csv(here("data/RKI_Impf/aufbereitete_daten/RKI_Impf_heute_blatt_2.csv"))
}
if (!exists("RKI_Impf_heute_blatt_3")) {
RKI_Impf_heute_blatt_3 <- read_csv(here("data/RKI_Impf/aufbereitete_daten/RKI_Impf_heute_blatt_3.csv"))
}
if (!exists("RKI_Impf_heute_blatt_4")) {
RKI_Impf_heute_blatt_4 <- read_csv(here("data/RKI_Impf/aufbereitete_daten/RKI_Impf_heute_blatt_4.csv"))
}

if (!exists("DIVI_Intensiv")) {
DIVI_Intensiv <- read_csv(here("data/DIVI_Intensiv/aufbereitet/divi_intesiv_aufbereitet.csv"))
}

if (!exists("RKI_R_Wert")) {
RKI_R_Wert <- read_csv(here("data/RKI_RWert/working/RKI_RWert_heute.csv"))
}

if (!exists("RKI_Wochen_Inzidenz")) {
RKI_Wochen_Inzidenz <- read_excel(here("data/RKI_WochenInzidenz/Altersverteilung.xlsx"),sheet = 2)
}




Lockdown1 = as.Date("2020-03-22")
Lockdown2 = as.Date("2020-11-02")
MaxDatum = max(RKI_COVID19$Meldedatum)
MinDatum = min(RKI_COVID19$Meldedatum)
EinwohnerzahlBund = 83166711
  #83187500

#RKI_Landkreise laden und für die Einwohnerzahlen aufbereiten
RKI_Corona_Landkreise <- read_csv(here("data/RKI_Corona_Landkreise.csv"))
Einwohner_Bundesland_Landkreise_df = RKI_Corona_Landkreise %>% 
  select(RS, EWZ, EWZ_BL) %>% 
  rename(IdLandkreis = RS,
         EWZ_LK = EWZ) 


```

# Tagesaktuelle Zahlen {data-icon="fa-sticky-note"}

## Row {data-height="125"}

### Neuinfektionen Gesamt

```{r}
Bund_ZumVortag_df = RKI_COVID19 %>%
  filter(NeuerFall %in% c(-1, 1)) %>%
  summarise(Bundesland= "Gesamt",
            "Differenz zum Vortag" = sum(AnzahlFall))

valueBox(
  NummernMitPunkt(Bund_ZumVortag_df$`Differenz zum Vortag`),
  icon = "fa-plus",
  caption = "Neuinfektionen Gesamt",
  color = ifelse(Bund_ZumVortag_df$`Differenz zum Vortag` == max(Neufindektion_Datum_df$Neuinfektionen), "warning", "primary"))
```

### Bund_Fälle_Gesamt

```{r}
Bund_Fälle_Gesamt_df = RKI_COVID19 %>%
  filter(NeuerFall %in% c(0,1)) %>%
  summarise(Bundesland = "Gesamt",
            Anzahl = sum(AnzahlFall))

valueBox( glue::glue("{NummernMitPunkt(Bund_Fälle_Gesamt_df$Anzahl)} / {NummernMitPunkt(round(Bund_Fälle_Gesamt_df$Anzahl/EinwohnerzahlBund*100,2),digits = 2)}%"),
         icon = "fa-stethoscope",
         caption = "Anzahl aller Infizierter",
         color = "info")

```

### 7 Tage Inzidenz

```{r}
# Bund = RKI_COVID19 %>%
#   filter(NeuerFall %in% c(0, 1)) %>%
#   group_by(Meldedatum) %>%
#   summarise(AnzahlFall = sum(AnzahlFall)) %>%
#   ungroup() %>%
#   mutate(ma_AnzahlFall = round(ma(AnzahlFall)))
# 
# LetzteWocheInzidenz = Bund %>% 
#   filter(Meldedatum>Sys.Date()-8) %>% 
#   select(AnzahlFall) %>% 
#   sum()
# 
# 
# VorletzteWocheInzidenz = Bund %>% 
#   filter(Meldedatum>Sys.Date()-15) %>% 
#   filter(Meldedatum<Sys.Date()-7) %>% 
#   select(AnzahlFall) %>% 
#   sum()
# 
# 
# 
# LetzteWocheInzidenz = round(LetzteWocheInzidenz/(EinwohnerzahlBund/100000),1)
# VorletzteWocheInzidenz = round(VorletzteWocheInzidenz/(EinwohnerzahlBund/100000),1)
# 
# valueBox(NummernMitPunkt(LetzteWocheInzidenz,digits = 1), 
#          icon = ifelse(LetzteWocheInzidenz>VorletzteWocheInzidenz,"fa-arrow-up","fa-arrow-down"),
#          caption = "7 Tage Inzidenz", 
#          color = ifelse(LetzteWocheInzidenz>VorletzteWocheInzidenz,"#cd6689","#66CDAA"))



Neufindektion_heute <- Neufindektion_Datum_df %>% 
  filter(Datum == max(Datum)) 

Neufindektion_gestern <- Neufindektion_Datum_df %>% 
  filter(Datum == max(Datum)-1) 
  

valueBox(glue::glue("{NummernMitPunkt(Neufindektion_heute$Sieben_Tage_Inzidenz,digits = 1)} ({VergleichVortagePfeil(Neufindektion_Datum_df,Sieben_Tage_Inzidenz)})"),
         icon = ifelse(Neufindektion_heute$Sieben_Tage_Inzidenz>Neufindektion_gestern$Sieben_Tage_Inzidenz,"fa-arrow-up","fa-arrow-down"),
         caption = "7 Tage Inzidenz",
         color = ifelse(Neufindektion_heute$Sieben_Tage_Inzidenz>Neufindektion_gestern$Sieben_Tage_Inzidenz,"#cd6689","#66CDAA"))

  


```

### Todesfälle Heute

```{r TodesfälleHeute}
Bund_todesfälle_gesamt_df = RKI_COVID19 %>%
  filter(NeuerTodesfall %in% c(-1,1)) %>%
  summarise(Bundesland = "Gesamt",
            Anzahl = sum(AnzahlFall))

valueBox(
  NummernMitPunkt(Bund_todesfälle_gesamt_df$Anzahl),
  icon = "fa-heart",
  caption = "Neu gemeldete Todesfälle",
  color = "#7e7e7e")
```

## Row {data-height="125"}

### Neue Impfungen Gestern

```{r NeueImpfungenGestern}
# RKI_Impf_gestern <- RKI_Impf %>%
#   group_by(date) %>% 
#   summarize(impfungen_kumulativ = sum(erstimpfung_impfungenkumulativ_gesamt,na.rm = TRUE),
#             differenz_zum_vortag = sum(erstimpfung_differenz_zum_vortag,na.rm = TRUE)) %>% 
#   arrange(desc(date)) %>% 
#   .[1,] 
# 

RKI_Impf_gestern <- RKI_Impf_heute_blatt_4 %>%
  filter(date == max(date,na.rm = TRUE))


  valueBox(
  NummernMitPunkt(RKI_Impf_gestern$erstimpfung),
  icon = "fa-plus",
  caption = glue::glue("Neue Erstimpfungen (Stand {RKI_Impf_gestern$date +1})"),
  color = "primary")
```

### Anzahl aller Geimpften

```{r AnzahlallerGeimpften}
RKI_Impf_Summe_Erstimpfungen <- sum(RKI_Impf_heute_blatt_4$erstimpfung,na.rm = TRUE)

  valueBox(
  NummernMitPunkt(RKI_Impf_Summe_Erstimpfungen),
  icon = "fa-thumbs-o-up",
  caption = glue::glue("Anzahl aller Erstimpfungen (Stand {RKI_Impf_gestern$date +1})"),
  color = "info")
```

### Impfqoute

```{r Impfqoute}
valueBox(
  glue::glue("{NummernMitPunkt(round(RKI_Impf_Summe_Erstimpfungen/EinwohnerzahlBund*100,2),digits = 2)}%"),
  icon = "fa-percent",
  caption = glue::glue("Anzahl aller Geimpften (Stand {RKI_Impf_gestern$date +1})"),
  color = "#66cccc")
```


### Impfqoute Zweitimpfung

```{r Impfqoute Zweitimpfung}
RKI_Impf_Summe_Zweitimpfungen <- sum(RKI_Impf_heute_blatt_4$zweitimpfung,na.rm = TRUE)
RKI_Impf_Summe_Zweitimpfungen <- RKI_Impf_heute_blatt_2 %>% 
  filter(bundesland == "Gesamt") %>% 
  mutate(impfquote_vollstandig_geimpft_gesamt = as.numeric(impfquote_vollstandig_geimpft_gesamt)) %>% 
  .$impfquote_vollstandig_geimpft_gesamt



valueBox(
  glue::glue("{NummernMitPunkt(round(RKI_Impf_Summe_Zweitimpfungen,2),digits = 2)}%"),
  icon = "fa-percent",
  caption = glue::glue("Anzahl vollständig geimpfter (Stand {RKI_Impf_gestern$date +1})"),
  color = "#66cccc")
```




## Row {data-height="125"}

### DIVI-Intesiv

```{r DIVI-Intesiv}
DIVI_Intensiv_heute <- DIVI_Intensiv %>%
  summarise(faelle_covid_aktuell = last(faelle_covid_aktuell))

DIVI_Intensiv_gestern <- DIVI_Intensiv %>%
  filter(date == (max(date) - 1)) %>%
  summarise(faelle_covid_aktuell = last(faelle_covid_aktuell))

DIVI_Intensiv_sieben_tage_durchschnitt <- DIVI_Intensiv %>%
  filter(date > (max(date) - 8)) %>%
  filter(date < max(date)) %>%
  summarise(faelle_covid_aktuell = mean(faelle_covid_aktuell))

# DIVI_Intensiv %>%
#   filter(date > (max(date) - 7)) %>%
# #  filter(date < max(date)) %>%
#   select(-betten_belegt) %>% 
#   lm(date ~ faelle_covid_aktuell, data = .) 
  
valueBox(
  glue::glue("{DIVI_Intensiv_heute} ({VergleichVortagePfeil(DIVI_Intensiv,faelle_covid_aktuell)})"),
  icon = "fa-hospital-o",
  caption = glue::glue("Belegte Intensivbetten (Stand {max(DIVI_Intensiv$date)})"),
  color = ifelse(DIVI_Intensiv_heute>DIVI_Intensiv_sieben_tage_durchschnitt,"#cd6689","#66CDAA"))
```


```{r RWert_vier_Tage, eval=FALSE, include=FALSE}

### RWert_vier_Tage

RWert_vier_Tage <- RKI_R_Wert %>% 
  select(Datum,PS_4_Tage_R_Wert ) %>% 
  filter(Datum == max(Datum)) %>%
  summarise(PS_4_Tage_R_Wert)

valueBox(
  glue::glue("{RWert_vier_Tage} ({VergleichVortagePfeil(RKI_R_Wert,PS_4_Tage_R_Wert)})"),
  icon = "fa-line-chart",
  caption = glue::glue("R-Wert (Stand {max(RKI_R_Wert$Datum)+4})"),
  color = "#FFBC00")

```

### RWert_sieben_Tage

```{r RWert_sieben_Tage}


RWert_sieben_Tage <- RKI_R_Wert %>%
  select(Datum,PS_7_Tage_R_Wert) %>% 
  filter(Datum == max(Datum)-1) %>%
  summarise(PS_7_Tage_R_Wert)

valueBox(
  glue::glue("{RWert_sieben_Tage} ({VergleichVortagePfeil(RKI_R_Wert,PS_7_Tage_R_Wert)})"),
  icon = "fa-line-chart",
  caption = glue::glue("R-Wert 7 Tage (Stand {max(RKI_R_Wert$Datum)-1+5})"),
  color = "#FFCC00")

```

## Row {data-height="625"}

### Bundesländer

```{r}
Bund_ZumVortag_df = RKI_COVID19 %>%
  filter(NeuerFall %in% c(-1,1)) %>% 
  summarise(Bundesland = "Gesamt",
            "Differenz zum Vortag" = sum(AnzahlFall)) 

#Anzahl aller Covid Fälle seit beginn  (Anzahl Fälle der aktuellen Publikation als Summe(AnzahlFall), wenn NeuerFall in (0,1))
Bund_Fälle_Gesamt_df = RKI_COVID19 %>%
  filter(NeuerFall %in% c(0,1)) %>%
  summarise(Bundesland = "Gesamt",
            Anzahl = sum(AnzahlFall))

Bund_Tabelle_df = full_join(Bund_ZumVortag_df, Bund_Fälle_Gesamt_df, by = "Bundesland")


#Bundesländer Tabelle. Infektionen zum Vortag 
#Bundesländer heute zum Vortag neue Fälle nach Bundesland
Bundeslaender_ZumVortag_df = RKI_COVID19 %>% 
  filter(NeuerFall %in% c(-1,1)) %>% 
  group_by(Bundesland) %>% 
  summarise(AnzahlFall = sum(AnzahlFall)) %>%
  `colnames<-`(c("Bundesland","Differenz zum Vortag")) %>% 
  arrange(Bundesland)

#Bundesländer Fälle Gesamt
Bundeslaender_FälleGesamt_df = RKI_COVID19 %>% 
  filter(NeuerFall %in% c(0,1)) %>% 
  group_by(Bundesland) %>% 
  summarise(AnzahlFall = sum(AnzahlFall)) %>% 
  `colnames<-`(c("Bundesland","Anzahl")) %>% 
  arrange(Bundesland)

#Bundesländer Tabelle. Infektionen zum Vortag
Bundesländer_Tabelle_df = full_join(Bundeslaender_ZumVortag_df, Bundeslaender_FälleGesamt_df,  by = "Bundesland")


Bundesländer_Bund_Tabelle_df = bind_rows(Bundesländer_Tabelle_df,Bund_Tabelle_df)


#Tabelle für 7 Tage inzidenz erstellen
Bundesländer_Bund_7_Tabelle_df = RKI_COVID19 %>%
  filter(NeuerFall %in% c(0, 1)) %>% 
  rename(date = Meldedatum) %>%
  cross_by_dimensions(Bundesland) %>%
  cross_by_periods(windows = c(7)) %>% #Ordenet sich wohl vom heutigen Tag an nicht vorm ersten aus dem Datensatz 
  summarize(AnzahlFall = sum(AnzahlFall)) %>% 
  rename("Fälle in den letzen 7 Tagen" = AnzahlFall) %>% 
  filter(date == Sys.Date()-1,
         period == "rolling_7d") %>% 
  mutate(Bundesland = ifelse(Bundesland=="All","Gesamt",Bundesland))


Einwohner_Bundesland_df = read_csv2("data/einwohner_bundesland.csv") 
Einwohner_Bundesland_df = Einwohner_Bundesland_df %>% 
  add_row(tibble_row(Bundesland = "Gesamt", Einwohner = sum(Einwohner_Bundesland_df$Einwohner)))


Bundesländer_Bund_7Tage_Inzidenz_Tabelle_df = full_join(Einwohner_Bundesland_df, Bundesländer_Bund_7_Tabelle_df,   by = "Bundesland")

Bundesländer_Bund_7Tage_Inzidenz_Tabelle_df = Bundesländer_Bund_7Tage_Inzidenz_Tabelle_df %>% 
  mutate("7 Tage Inzidenz" = round((`Fälle in den letzen 7 Tagen`/Einwohner)*100000,1)) %>% 
  select(Bundesland,`Fälle in den letzen 7 Tagen`,`7 Tage Inzidenz`)
  


Bundesländer_Bund_Tabelle_df = full_join(Bundesländer_Bund_Tabelle_df, Bundesländer_Bund_7Tage_Inzidenz_Tabelle_df,   by = "Bundesland")


Bundesländer_Bund_Tabelle_df%>%
  select(Bundesland,`7 Tage Inzidenz`,`Differenz zum Vortag`,  Anzahl, `Fälle in den letzen 7 Tagen`) %>% 
    mutate(`Differenz zum Vortag`  = NummernMitPunkt(`Differenz zum Vortag` ),
         Anzahl = NummernMitPunkt(Anzahl),
         `Fälle in den letzen 7 Tagen` = NummernMitPunkt(`Fälle in den letzen 7 Tagen`),
         `7 Tage Inzidenz` = NummernMitPunkt(`7 Tage Inzidenz`,digits = 1)) %>% 
  kbl(align = c("l","r","r","r","r")) %>% 
  kable_material() %>% 
    row_spec(17,
           bold = T,
           background = "#DCDCDC") %>% 
  kable_styling(bootstrap_options = c("condensed","hover"),
                full_width = F,
                position = "left",
                fixed_thead = T,
                html_font = "helvetica",
                font_size = 16)


```

### Städte

```{r include=FALSE}
RKI_Corona_Landkreise <- read_csv("data/RKI_Corona_Landkreise.csv")
Einwohner_Bundesland_Landkreise_df = RKI_Corona_Landkreise %>% 
  select(RS, EWZ, EWZ_BL) %>% 
  rename(IdLandkreis = RS,
         EWZ_LK = EWZ) 
```

```{r}
Städte = c("SK Darmstadt","LK Darmstadt-Dieburg", "SK Frankfurt am Main","SK Düsseldorf","LK Offenbach","SK Köln","SK Wiesbaden","LK Rhein-Kreis Neuss","SK Würzburg")

Städte_Tabelle_df = RKI_COVID19 %>%
  mutate(Fallzahl = ifelse(NeuerFall %in% c(0,1),AnzahlFall,0),
         Fallzahl_neu = ifelse(NeuerFall %in% c(-1,1),AnzahlFall,0),
         Todesfall = ifelse(NeuerTodesfall %in% c(0,1),AnzahlTodesfall,0),
         Todesfall_neu = ifelse(NeuerTodesfall %in% c(-1,1),AnzahlTodesfall,0),
         Genesen = ifelse(NeuGenesen %in% c(0,1),AnzahlGenesen,0),
         Genesen_neu = ifelse(NeuGenesen %in% c(-1,1),AnzahlGenesen,0)) %>% 
  group_by(Meldedatum, Landkreis,IdLandkreis) %>% 
  summarize(Fallzahl = sum(Fallzahl),
            Fallzahl_neu = sum(Fallzahl_neu),
            Todesfall = sum(Todesfall),
            Todesfall_neu = sum(Todesfall_neu),
            Genesen = sum(Genesen),
            Genesen_neu = sum(Genesen_neu)) %>%
    filter(Landkreis %in% Städte) %>%
  ungroup() %>% 
  group_by(Landkreis,IdLandkreis) %>% 
  complete(Meldedatum = seq.Date(min(MinDatum), max(MaxDatum), by="day")) %>% 
  replace(is.na(.), 0) %>% 
  mutate(SiebenTageSumme = ms(Fallzahl)) %>% 
  ungroup() %>% 
  group_by(Landkreis,IdLandkreis) %>% 
  summarise(Fallzahl = sum(Fallzahl),
            Fallzahl_neu = sum(Fallzahl_neu),
            Todesfall = sum(Todesfall),
            Todesfall_neu = sum(Todesfall_neu),
            Genesen = sum(Genesen),
            Genesen_neu = sum(Genesen_neu),
            SiebenTageSumme = last(SiebenTageSumme)) %>% 
  left_join(., Einwohner_Bundesland_Landkreise_df,   by = "IdLandkreis") %>% 
  mutate(SiebenTageInzidenz = round((SiebenTageSumme/EWZ_LK)*100000,1)) %>% 
  ungroup()


Städte_Tabelle_df %>% 
  select(Landkreis,SiebenTageInzidenz, Fallzahl_neu, Fallzahl,SiebenTageSumme) %>% 
      arrange(SiebenTageInzidenz) %>% 
  mutate(Fallzahl = NummernMitPunkt(Fallzahl),
         Fallzahl_neu = NummernMitPunkt(Fallzahl_neu),
         SiebenTageSumme = NummernMitPunkt(SiebenTageSumme),
         SiebenTageInzidenz = NummernMitPunkt(SiebenTageInzidenz,digits = 1)) %>% 


  rename("Differenz zum Vortag" = Fallzahl_neu,
         Anzahl = Fallzahl,
         "Fälle in den letzen 7 Tagen" = SiebenTageSumme,
         "7 Tage Inzidenz" = SiebenTageInzidenz) %>% 

  kbl(align = c("l","r","r","r","r")) %>% 
  kable_material() %>% 
  kable_styling("hover",
                full_width = F,
                position = "left",
                fixed_thead = T,
                html_font = "helvetica",
                font_size = 16)
```

# Infektionen {data-icon="fa-bar-chart"}

## Row {data-height="500"}

<!-- ### Bundesländer -->

```{r include=FALSE}
Bund_BL_Gesamt = RKI_COVID19 %>%
  filter(NeuerFall %in% c(0, 1),
         Meldedatum > as.Date("2020-03-01")) %>%
  rename(date = Meldedatum) %>%
  cross_by_dimensions(Bundesland) %>%
  cross_by_periods(c("day", "week", "month", "quarter")) %>%
  summarize(AnzahlFall = sum(AnzahlFall))


#Moving Avarage Funktion 
  ma <- function(x, n = 7) {
    stats::filter(x, rep(1 / n, n), sides = 2)
  }

ggplotly(
Bund_BL_Gesamt %>%
  filter(period == "day",
  Bundesland != "All") %>%
  mutate(maAnzahlFall = ma(AnzahlFall)) %>% 
  ggplot(aes(date, AnzahlFall, fill = Bundesland)) +
  geom_col() +
  geom_line(
    aes(date, maAnzahlFall,col=Bundesland),
    color = "black",
    alpha = .9,
    size = 0.8)+
  
  #Lockdown
  geom_vline(xintercept = as.numeric(Lockdown2),
             color = "#000066",
             size = 0.3,
             alpha = 0.9) +
  
  #Beschriftung und Zoomen
  scale_x_date(
    date_breaks = "1 month",
    date_labels = "%W") +
  coord_cartesian(xlim = c(Sys.Date() - 90, NA),
                  ylim = c(0, NA)) +
      labs(x = "",
       y = "Fallzahlen",
       title = "")+
  theme(legend.position = "none")+
  
  facet_wrap(~ Bundesland, ncol=4, scales="free_y")+
  theme_fivethirtyeight()+
  theme(legend.position = "none")
)

```

### Fallzahlen Deutschland

```{r}

ma <- function(x, n = 7) {
  stats::filter(x, rep(1 / n, n), sides = 2)
}

Bund = RKI_COVID19 %>%
  filter(NeuerFall %in% c(0, 1)) %>%
  group_by(Meldedatum) %>%
  summarise(AnzahlFall = sum(AnzahlFall)) %>%
  ungroup() %>%
  mutate(ma_AnzahlFall = round(ma(AnzahlFall))) %>%
  mutate(max_AnzahlFall = ifelse(AnzahlFall == max(AnzahlFall), "1", "0"),
         wochenende = ifelse(weekdays(as.Date(Meldedatum)) %in% c("Sonntag","Samstag","Sunday","Saturday"),"1","0")) %>% 
  ggplot(aes(Meldedatum, AnzahlFall, fill = max_AnzahlFall, alpha = wochenende)) +
  geom_col(
           width = 0.8) +
  scale_fill_manual(values = c("1" = "red", "0" = "black"), guide = FALSE) +
  scale_alpha_manual(values = c("1" = 0.6, "0" = 1), guide = FALSE) +

  geom_vline(xintercept = as.numeric(Lockdown1),
             color = "#000066",
             size = 0.5,
             alpha = 0.9 ) +
  geom_vline(xintercept = as.numeric(Lockdown2),
             color = "#000066",
             size = 0.5,
             alpha = 0.9) +
  geom_line(aes(Meldedatum, ma_AnzahlFall),
            color = "red",
            alpha = .8,
            size = 0.95 ) +

  scale_x_date(date_breaks = "1 month",
               date_labels = "%b %y") +
  coord_cartesian(xlim = c(as.Date("2020-03-10"), NA)) +
  scale_y_continuous(expand = c(0, 0))+
  theme(legend.position = "none")

ggplotly(Bund)
```

## Row {data-height="500"}

### 7 Tage Inzidenzts Graph

```{r}
BL_Tabelle_df = RKI_COVID19 %>%
  rename(date = Meldedatum) %>%
  mutate(Fallzahl = ifelse(NeuerFall %in% c(0,1),AnzahlFall,0),
         Fallzahl_neu = ifelse(NeuerFall %in% c(-1,1),AnzahlFall,0)) %>% 
  group_by(date, Bundesland) %>% 
  summarize(Fallzahl = sum(Fallzahl),
            Fallzahl_neu = sum(Fallzahl_neu)) %>%
  ungroup() %>% 
  group_by(Bundesland) %>% 
  complete(date = seq.Date(min(MinDatum), max(MaxDatum), by="day")) %>% 
  replace(is.na(.), 0) %>% 
  mutate(SiebenTageSumme = ms(Fallzahl)) %>% 
  ungroup() %>% 
  cross_by_dimensions(Bundesland) %>%
  mutate(Bundesland = ifelse(Bundesland=="All","Gesamt",Bundesland)) %>% 
  group_by(Bundesland,date) %>% 
  summarise(Fallzahl = sum(Fallzahl),
            Fallzahl_neu = sum(Fallzahl_neu),
            SiebenTageSumme = sum(SiebenTageSumme)) %>% 
  left_join(., Einwohner_Bundesland_df,   by = "Bundesland") %>% 
  mutate(SiebenTageInzidenz = round((SiebenTageSumme/Einwohner)*100000,1)) %>% 
  ungroup() %>% 
  mutate(Bundesland = fct_reorder(Bundesland,Einwohner,.desc = F)) 


ggplotly(
  
BL_Tabelle_df %>%
  filter(date > Sys.Date()-50) %>%
    ggplot(aes(date, SiebenTageInzidenz,color = Bundesland, size = Bundesland))+
  geom_line()+
  scale_size_manual(values = c(.5, .5, .5, .5, .5, .5, .5, .5, .5, .5, .5, .5, .5, .5, .5, .5, 1.5))+
  scale_color_manual(values = c("#0000ff","#663399","#99cc66","#0099ff","#666666","#66cccc","#ff9933","#cc99cc","#000000","#ff0000","#cc3333","#ffcc33","#ff99ff","#cccc99","#009966","#cc66ff", "#cc6600"))+
   scale_x_date(
    date_breaks = "3 day",
    date_labels = "%d.%m")+ 
  theme(axis.text.x = element_text(angle = 45)) 


  

)

```

### Coronafallzahlen pro Woche

```{r}

ggplotly(
Bund_BL_Gesamt %>%
  filter(period == "week",
         Bundesland == "All") %>%
  ggplot(aes(date, AnzahlFall, fill = Bundesland)) +
  scale_fill_manual(values = c("All" = "black"), guide = FALSE) +
  geom_col()+
    labs(x = "",
         y = "Fallzahlen",
         title = "")+
  scale_x_date(date_breaks = "1 month",
               date_labels = "%b %y") +
  coord_cartesian(xlim = c(as.Date("2020-03-10"), NA)) +
  scale_y_continuous(expand = c(0, NA))+
  theme(legend.position = "none")

)
```

# Impfungen {data-icon="fa-bar-chart"}

## Row {data-height="1000"}


### Anzahl der Impfungen pro Tag Bundesweit `r glue::glue("(Stand {max(RKI_Impf_heute_blatt_4$date) +1})")`  {data-width=550}

```{r Impfverlauf}
ggplotly(
RKI_Impf_heute_blatt_4 %>%
  pivot_longer(!date, names_to = "Impfung", values_to = "Anzahl_Impfung") %>% 
  filter(Impfung != "gesamtzahl_verabreichter_impfstoffdosen") %>% 

  ggplot(aes(x = date, y = Anzahl_Impfung, fill = Impfung)) +
    geom_bar(stat="identity", position ="identity",alpha = 0.9) +
    scale_fill_manual(values=c("#0d143b","#007500","#143b0d")) +
    labs(x = "",
         y = "Impfungen",
         title = "Anzahl der täglichen Erst- & Zweitimpfungen bundesweit")+
    scale_y_continuous(labels = function(x) NummernMitPunkt(x,digits = 0))
) 
```


### Prozent der Impfungen pro Bundesland `r glue::glue("(Stand {max(RKI_Impf_heute_blatt_4$date+1)})")` {data-width=450}

```{r Impfungen_Prozent_Bundesland}
ggplotly(
RKI_Impf_heute_blatt_2 %>% 
  filter(bundesland != "Bundesressorts**") %>% 
  filter(bundesland != "Impfzentren Bund***") %>% 
  
  mutate(prozent_geimpft_erste = round(as.numeric(impfquote_mindestens_einmal_geimpft_gesamt)/1,2),
         prozent_geimpft_zweite = round(as.numeric(impfquote_vollstandig_geimpft_gesamt)/1,2),
         bundesland = fct_reorder(bundesland,sort(bundesland,decreasing = T))) %>% 
  ggplot(aes(y = bundesland))+
  scale_x_continuous(labels = function(x) paste0(NummernMitPunkt(x,digits = 1), '%'))+
  coord_cartesian(xlim = c(0,100))+
  geom_col(aes(x = prozent_geimpft_erste),fill = "#007500")+
  geom_col(aes(x = prozent_geimpft_zweite),fill = "#143b0d")+

    labs(x = "Prozent geimpft",
         y = "",
         title = "Prozent der geimpften pro Bundesland")
)
```

```{r Impfungen_Prozent_Bundesland_alt, eval=FALSE, include=FALSE}
ggplotly(
RKI_Impf %>% 
  filter(date == max(date)) %>% 
  mutate(prozent_geimpft = round(erstimpfung_impfquote_percent/1,2),
         bundesland = fct_reorder(bundesland,sort(bundesland,decreasing = T))) %>% 
  ggplot(aes(x = prozent_geimpft, y = bundesland))+
  scale_x_continuous(labels = function(x) paste0(NummernMitPunkt(x,digits = 1), '%'))+
  coord_cartesian(xlim = c(0,100))+
  geom_col(fill = "black")+
    labs(x = "Prozent geimpft",
         y = "",
         title = "Prozent der geimpften pro Bundesland")
)
```

# DIVI-Intensiv {data-icon="fa-bar-chart"}

## Row {data-height="1000"}

### DIVI-Intensivzahlen `r glue::glue("(Stand {max(DIVI_Intensiv$date)})")`

```{r DIVI-Intensivzahlen}
ggplotly(
DIVI_Intensiv %>%
  ggplot(aes(x = date , y = faelle_covid_aktuell)) +
  geom_line() +
    labs(x = "Datum",
         y = "Intensivpatienten mit SARS-COV2",
         title = "Belegung der deutschen Intensivbetten ") +
  scale_x_date(date_breaks = "1 month",
               date_labels = "%b %y")
)
```


# Demografische Verteilung {data-icon="fa-bar-chart"}

## Row {data-height="1000"}

### Inzidenzen in den Altersgruppen pro Woche  


```{r RKI_Wochen_Inzidenz_daten}
textcol <- "grey40"

Altersverteilung_Plot <- RKI_Wochen_Inzidenz %>% 
  pivot_longer(!Altersgruppe, names_to = "Kalenderwoche",values_to = "inzidenz") %>% 
  mutate(Kalenderwoche = str_replace(Kalenderwoche,"\\_","-")) %>% 
  mutate(woche = str_remove(Kalenderwoche,"....-"),
         Jahr = str_remove(Kalenderwoche,"-.."),
         Jahr = str_remove(Kalenderwoche,"-."),
         Kalenderwoche2 = str_remove(Kalenderwoche,"-")) %>%
  mutate(Kalenderwoche2 = as.numeric(Kalenderwoche2)) %>%
  group_by(Altersgruppe) %>% 
  mutate(fct_level = seq(from = 1, to = length(woche), by = 1)) %>% 
  ungroup() %>% 
  
  
  mutate(woche = fct_reorder(woche,fct_level,.fun = max)) %>% 
  mutate(Kalenderwoche = fct_reorder(Kalenderwoche,fct_level,.fun = max)) %>% 
  # create a new variable from inzidenz
  mutate(inzidenzfactor=cut(inzidenz,breaks=c(0,5,10,15,20,35,50,100,150,200,300,600,max(inzidenz,na.rm=T)),
                            labels=c("0-5",
                                     "5-10",
                                     "10-15",
                                     "15-20",
                                     "20-35",
                                     "35-50",
                                     "50-100",
                                     "100-150",
                                     "150-200",
                                     "200-300",
                                     "300-600",
                                     ">600"))) %>%
  mutate(inzidenzfactor=factor(as.character(inzidenzfactor),levels=levels(inzidenzfactor))) %>% 
  mutate(Altersgruppe = as.factor(Altersgruppe)) %>% 
  mutate(Altersgruppe = factor(Altersgruppe,levels(Altersgruppe)[c(1,10,2,3,4,5,6,7,8,9,11:20)])) 
#  mutate(Altersgruppe = factor(Altersgruppe,levels(Altersgruppe)[c(1,18,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,19,20)]))
```


```{r RKI_Wochen_Inzidenz_plott}
ggplotly(
Altersverteilung_Plot %>% 
  ggplot(aes(y = Altersgruppe, x = Kalenderwoche, fill = inzidenzfactor))+
  geom_tile(colour="white",size=0.2)+
  scale_y_discrete(expand=c(0,0))+
  scale_fill_manual(values=c("#cfcfe8","#a6bddc","#7cacd2","#a7c883","#e4ef26","#fee600","#febd00","#fb8800","#fd3c00","#f40001","#be0000","#8b0101"))+
  labs(x="Kalenderwoche",
       y="",
       fill = "Inzidenzen",
       title = "Wöchentliche COVID-19-Inzidenz (pro 100.000)")+
  theme_grey(base_size=10)+
  theme(legend.position="right",legend.direction="horizontal", legend.box = "horizontal",
          legend.title=element_text(colour=textcol),
          legend.margin=margin(grid::unit(0,"cm")),
          legend.text=element_text(colour=textcol,size=7,face="bold"),
          legend.key.height=grid::unit(0.8,"cm"),
          legend.key.width=grid::unit(0.2,"cm"),
          axis.text.x=element_text(size=9,colour=textcol,angle=45,hjust=1),
          axis.text.y=element_text(vjust=0.2,colour=textcol),
          axis.ticks=element_line(size=0.4),
          plot.background=element_blank(),
          panel.border=element_blank(),
          plot.margin=margin(0.7,0.4,0.1,0.2,"cm"),
          plot.title=element_text(colour=textcol,hjust=0,size=14,face="bold"))+
  geom_text(aes(y= Altersgruppe,label=round(inzidenz,digits = 0)),
            size = 2.5)
)
```


```{r RKI_Wochen_Inzidenz}
```





```{r beep}
beepr::beep(1)
```
